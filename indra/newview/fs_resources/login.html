<!DOCTYPE html>
<meta charset="utf-8">
<title>LOstorm 18</title>
<style>
:root
{
	--news-text-color: #ffffff;
	--news-background-color: #4040601a;
	--news-border-color: #82b4d2;
	--news-text-shadow: #82b4d280;
	--news-hr-color: #82b4d2;
	--credit-text-color: #82b4d2;
	--credit-background-color: #00000099;
	--version-text-color: #c6e3f4;
	--version-text-shadow: #b2b4d2cc;
}

body
{
	padding: 0;
	margin: 0;

	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;

	background: #111111 center center fixed;
	background-repeat: no-repeat;
	background-size: cover;

	font-family: sans-serif;
	font-size: 10pt;
}

#floatbox
{
	position: absolute;
	bottom: 2em;
	left: 2em;
}

#contentbox
{
	width: 20em;

	padding: 0.4em 1.5ex;
	border: solid var(--news-border-color);
	border-width: 4;

	background-color: var(--news-background-color);
	backdrop-filter: blur(16px);
	opacity: 0.9;
	color: var(--news-text-color);
	text-shadow: var(--news-text-shadow) 0 0 4px;
	font-size: 1.2vw;
}

#decorationbox
{
	position: absolute;
	top: 0;
	left: 0;
	display: block;
	opacity: 0.4;
	filter: saturate(200%);
	background-size: cover;
	width: 12vw;
	height: 12vw;
}

#decorationbox img
{
	position: absolute;
	top: -4vw;
	left: -4vw;
	width: 12vw;
	height: 12vw;
}

#floatbox.flipped
{
	left: auto;
	right: 1em;
}

#overlay
{
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background-color: #c0c0c040;
}

#overlayinner
{
	margin: 5vw auto;
	width: 50vw;
	background-color: white;
	border: solid #CF3F3F 0.5vw;

	font-size: 1.6vw;
	text-align: center;
	line-height: 2.2vw;
}

#overlayinner h2
{
	color: #CF3F3F;
}
</style>
<noscript>
<style>
body { background-image:url('stormy.webp'); }
</style>
</noscript>
<script>
var news_urls = [
	"https://cdn.lop-sync.com/lostorm/news_v18.html",
	"https://gitlab.com/lostorm/lostorm/-/raw/zz-news/news_v18.html",
	"https://git.allthefallen.moe/lostorm/lostorm/-/raw/zz-news/news_v18.html",
	"https://lostorm.neocities.org/login_news_v18.txt"
];

async function get_remote_news()
{
	var news = null;
	var delay_time = 0;

	var promises = [];

	news_urls.forEach((url) => {
		promises.push(new Promise((resolve) => {
			setTimeout(() => {
				if (news !== null)
					return;
				console.log("Fetching news from", url);
				fetch(url).then(async (data) => {
					if (data.ok)
					{
						var body = await data.text();

						if (news !== null)
							return;

						if (body.search("<!--LOstorm-->") < 0)
						{
							console.log("Unrecognized data from", url);
							console.log(body.substr(0, 500));
							return;
						}

						console.log("Loaded news from", url);
						news = body;
						resolve();
					}
				});
			}, delay_time);
		}));

		delay_time += 3000;
	});

	await Promise.race(promises);
	return news;
}

async function render_remote_news(news)
{
	document.getElementById("news-anchor").innerHTML = news;
}

async function render_downtime()
{
	document.getElementById("news-anchor").innerHTML
		= "<p style=\"color:#ff3030\">Latest news is not loading.<br>Please visit <a href=\"https://lostorm.neocities.org/\" target=\"_blank\">lostorm.neocities.org</a> for updates/information.</p>";
}

async function load_remote_news(news)
{
	var timeout_id = setTimeout(() => render_downtime(), 15000);
	var news = await get_remote_news();
	clearTimeout(timeout_id);
	if (news)
		render_remote_news(news);
	else
		render_downtime();
}

function has_ext(s)
{
	var exts = [".jpg", ".jpeg", ".png", ".gif"];
	for (i = 0; i < exts.length; ++i)
	{
		if (s.substr(-exts[i].length) == exts[i])
			return true;
	}
	return false;
}

document.addEventListener("DOMContentLoaded", function() {
	var params = new URLSearchParams(window.location.search.substring(1));
	var bg_image = params.get('bg_image');

	if (bg_image)
	{
		document.getElementById('artist-credit').style.display = 'none';
	}
	else
	{
		bg_image = 'eden1.webp'
		document.body.style.backgroundPosition='center top';
	}

	document.body.style.backgroundImage='url(\'' + bg_image.replace(/'/, '\\\'') + '\')';

	load_remote_news();
});
</script>
<div id="floatbox" class="flipped">
<div id="decorationbox"><img src="snowflake.webp"></div>
<div id="contentbox">
<div id="news-anchor">
<p><b>Latest News:</b><br>
<p>Loading...
<noscript>
<p>(Javascript must be enabled)
</noscript>
</div>
<hr style="color:var(--news-hr-color);border-color:var(--news-hr-color);background-color:var(--news-hr-color);clear:both;border:none;height:1px;">
<p style="text-align:center;color:var(--version-text-color);text-shadow:var(--version-text-shadow) 0 0 4px;margin:0;padding:4px 0;">You are running <b id="version-anchor">LOstorm 18.0</b><br>based on Firestorm 7.2.2
</div>
</div>
<div style="position:absolute;bottom:2px;right:2px;font-size:12px;padding:2px;color:white;background-color:var(--credit-background-color)" id="artist-credit">
<span style="color:var(--credit-text-color)" target="_blank">Artist: GardenOfEden</span>
</div>
<div id="overlay" onclick="this.style.display = 'none'" style="display:none">
<div id="overlayinner" onclick="return false">
<h2>Warning!</h2>
<div id="warning"></div>
</div>
</div>
<script>
var w = document.getElementById("warning");
if (URLSearchParams != 'undefined')
{
	var params = new URLSearchParams(window.location.search.substring(1));
	var channel = params.get('channel');
	var grid = params.get('grid')
	var os = params.get('os')
	var nowarn = params.get('nowarn');
	var version = params.get('version');
	var loversion = params.get('loversion');

	var bad_version = false;
	var bad_channel = false;

	var linux = (os != null && os.match(/Linux/));

	if (loversion)
	{
		var vera = document.getElementById('version-anchor');
		vera.innerText = "LOstorm 18." + loversion;
	}

	if (channel != null && grid != null && os != null && version != null)
	{
		if (version != "7.2.2 (79439)")
			bad_version = true;

		if (channel != "Firestorm-Release" && channel != "Firestorm-Releasex64")
			bad_channel = true;
	}

	if (!nowarn)
	{
		if (bad_version)
			w.innerHTML += "<p>Viewer is configured with the wrong version number.<br>Logging in to Second Life may put your account at risk.";

		if (bad_channel)
			w.innerHTML += "<p>Viewer is configured with the wrong channel name.<br>Logging in to Second Life may put your account at risk.";

		if (bad_version || bad_channel)
		{
			document.getElementById("overlay").style.display = 'block';
		}
	}
}
</script>
